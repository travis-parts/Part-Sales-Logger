<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
      padding: 15px;
      margin: 0;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 13px;
      color: #42526e;
    }
    
    label .required {
      color: #eb5a46;
    }
    
    label .optional {
      color: #6b778c;
      font-weight: 400;
      font-style: italic;
    }
    
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 2px solid #dfe1e6;
      border-radius: 3px;
      font-size: 14px;
      box-sizing: border-box;
      font-family: inherit;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #0079bf;
    }
    
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    
    .checklist-items {
      margin-bottom: 10px;
    }
    
    .checklist-item {
      display: flex;
      gap: 5px;
      margin-bottom: 8px;
    }
    
    .checklist-item input {
      flex: 1;
    }
    
    .btn-remove {
      padding: 8px 12px;
      background: #eb5a46;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn-remove:hover {
      background: #cf513d;
    }
    
    .btn-add {
      padding: 8px 12px;
      background: #61bd4f;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 13px;
      margin-bottom: 15px;
    }
    
    .btn-add:hover {
      background: #5aac44;
    }
    
    .btn-primary {
      width: 100%;
      padding: 10px;
      background: #0079bf;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    
    .btn-primary:hover {
      background: #026aa7;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-authorize {
      width: 100%;
      padding: 10px;
      background: #61bd4f;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .btn-authorize:hover {
      background: #5aac44;
    }
    
    .error {
      color: #eb5a46;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    
    .auth-notice {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 10px;
      border-radius: 3px;
      margin-bottom: 15px;
      font-size: 13px;
    }
    
    .success-notice {
      background: #d4edda;
      border: 1px solid #28a745;
      padding: 10px;
      border-radius: 3px;
      margin-bottom: 15px;
      font-size: 13px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="authNotice" class="auth-notice">
    ⚠️ First time? Click "Authorize Power-Up" below to enable card creation.
  </div>
  
  <div id="successNotice" class="success-notice">
    ✓ Authorized! You can now create cards.
  </div>
  
  <button type="button" class="btn-authorize" id="authorizeBtn">Authorize Power-Up</button>
  
  <form id="cardForm">
    <div class="form-group">
      <label>Customer Name <span class="required">*</span></label>
      <input type="text" id="customerName" required placeholder="Enter customer name">
      <div class="error" id="customerNameError">Customer name is required</div>
    </div>
    
    <div class="form-group">
      <label>Equipment <span class="required">*</span></label>
      <input type="text" id="equipment" required placeholder="e.g., John Deere 5075E">
      <div class="error" id="equipmentError">Equipment is required</div>
    </div>
    
    <div class="form-group">
      <label>Phone Number <span class="optional">(optional)</span></label>
      <input type="tel" id="phone" placeholder="e.g., (555) 123-4567">
    </div>
    
    <div class="form-group">
      <label>Email Address <span class="optional">(optional)</span></label>
      <input type="email" id="email" placeholder="e.g., customer@email.com">
    </div>
    
    <div class="form-group">
      <label>Address <span class="optional">(optional)</span></label>
      <textarea id="address" placeholder="Enter customer address"></textarea>
    </div>
    
    <div class="form-group">
      <label>Parts Needed <span class="optional">(optional)</span></label>
      <div class="checklist-items" id="checklistItems">
        <div class="checklist-item">
          <input type="text" placeholder="Part # or description - Qty" class="part-item">
          <button type="button" class="btn-remove" onclick="removeItem(this)">✕</button>
        </div>
      </div>
      <button type="button" class="btn-add" onclick="addChecklistItem()">+ Add Part</button>
    </div>
    
    <div class="form-group">
      <label>Comments <span class="optional">(optional)</span></label>
      <textarea id="comments" placeholder="Any additional notes or comments"></textarea>
    </div>
    
    <button type="submit" class="btn-primary" id="submitBtn">Create Card</button>
  </form>

  <script>
    var t = TrelloPowerUp.iframe();
    var API_KEY = '57c447d193fc650177b14923e1ba4daf';
    
    function addChecklistItem() {
      var container = document.getElementById('checklistItems');
      var newItem = document.createElement('div');
      newItem.className = 'checklist-item';
      newItem.innerHTML = `
        <input type="text" placeholder="Part # or description - Qty" class="part-item">
        <button type="button" class="btn-remove" onclick="removeItem(this)">✕</button>
      `;
      container.appendChild(newItem);
    }
    
    function removeItem(button) {
      var items = document.querySelectorAll('.checklist-item');
      if (items.length > 1) {
        button.parentElement.remove();
      }
    }
    
    // Check if already authorized
    t.get('member', 'private', 'token').then(function(token) {
      if (token) {
        document.getElementById('authNotice').style.display = 'none';
        document.getElementById('successNotice').style.display = 'block';
        document.getElementById('authorizeBtn').textContent = 'Re-authorize';
      }
    });
    
    // Authorization button
    document.getElementById('authorizeBtn').addEventListener('click', function() {
      var authUrl = 'https://trello.com/1/authorize?' +
        'expiration=never&' +
        'name=Parts%20Sales%20Logger&' +
        'scope=read,write&' +
        'response_type=token&' +
        'key=' + API_KEY +
        '&return_url=' + encodeURIComponent(window.location.href);
      
      // Open in same window
      window.location.href = authUrl;
    });
    
    // Listen for token from authorization
    window.addEventListener('message', function(event) {
      if (event.origin !== 'https://trello.com') return;
      
      if (event.data && event.data.token) {
        t.set('member', 'private', 'token', event.data.token).then(function() {
          document.getElementById('authNotice').style.display = 'none';
          document.getElementById('successNotice').style.display = 'block';
          document.getElementById('authorizeBtn').textContent = 'Re-authorize';
          alert('Authorization successful! You can now create cards.');
        });
      }
    });
    
    // Check URL for token (from return_url)
    var urlParams = new URLSearchParams(window.location.hash.substring(1));
    var token = urlParams.get('token');
    if (token) {
      t.set('member', 'private', 'token', token).then(function() {
        document.getElementById('authNotice').style.display = 'none';
        document.getElementById('successNotice').style.display = 'block';
        document.getElementById('authorizeBtn').textContent = 'Re-authorize';
        // Clean up URL
        window.location.hash = '';
      });
    }
    
    document.getElementById('cardForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      var customerName = document.getElementById('customerName').value.trim();
      var equipment = document.getElementById('equipment').value.trim();
      var phone = document.getElementById('phone').value.trim();
      var email = document.getElementById('email').value.trim();
      var address = document.getElementById('address').value.trim();
      var comments = document.getElementById('comments').value.trim();
      
      // Validation
      var isValid = true;
      if (!customerName) {
        document.getElementById('customerNameError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('customerNameError').style.display = 'none';
      }
      
      if (!equipment) {
        document.getElementById('equipmentError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('equipmentError').style.display = 'none';
      }
      
      if (!isValid) return;
      
      // Get checklist items
      var partItems = Array.from(document.querySelectorAll('.part-item'))
        .map(input => input.value.trim())
        .filter(value => value !== '');
      
      // Build card description
      var description = '';
      if (phone) description += '**Phone:** ' + phone + '\n';
      if (email) description += '**Email:** ' + email + '\n';
      if (address) description += '**Address:** ' + address + '\n';
      
      // Create card name
      var cardName = customerName + ', ' + equipment;
      
      // Disable button
      var submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';
      
      // Get stored token
      t.get('member', 'private', 'token').then(function(token) {
        if (!token) {
          alert('Please authorize the Power-Up first by clicking "Authorize Power-Up" button.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create Card';
          return;
        }
        
        // Get board ID
        return t.board('id').then(function(board) {
          // Fetch all lists
          return fetch('https://api.trello.com/1/boards/' + board.id + '/lists?key=' + API_KEY + '&token=' + token)
            .then(function(response) {
              return response.json();
            })
            .then(function(lists) {
              // Find the target list
              var targetList = lists.find(function(list) {
                return list.name === 'Parts Requests | Start';
              });
              
              if (!targetList) {
                throw new Error('Could not find "Parts Requests | Start" list on your board.');
              }
              
              // Create the card
              return fetch('https://api.trello.com/1/cards?key=' + API_KEY + '&token=' + token, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  name: cardName,
                  desc: description,
                  idList: targetList.id
                })
              })
              .then(function(response) {
                if (!response.ok) {
                  throw new Error('Failed to create card');
                }
                return response.json();
              })
              .then(function(card) {
                var promises = [];
                
                // Create checklist if there are items
                if (partItems.length > 0) {
                  promises.push(
                    fetch('https://api.trello.com/1/checklists?key=' + API_KEY + '&token=' + token, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        idCard: card.id,
                        name: 'Parts Needed'
                      })
                    })
                    .then(function(response) {
                      return response.json();
                    })
                    .then(function(checklist) {
                      var itemPromises = partItems.map(function(item) {
                        return fetch('https://api.trello.com/1/checklists/' + checklist.id + '/checkItems?key=' + API_KEY + '&token=' + token, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ name: item })
                        });
                      });
                      return Promise.all(itemPromises);
                    })
                  );
                }
                
                // Add comment if provided
                if (comments) {
                  promises.push(
                    fetch('https://api.trello.com/1/cards/' + card.id + '/actions/comments?key=' + API_KEY + '&token=' + token, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ text: comments })
                    })
                  );
                }
                
                return Promise.all(promises).then(function() {
                  return card;
                });
              });
            });
        });
      })
      .then(function(card) {
        // Success!
        return t.closePopup();
      })
      .catch(function(error) {
        console.error('Error creating card:', error);
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Card';
      });
    });
  </script>
</body>
</html>
